{% extends "utils/base.html" %}
{% block title %}{% endblock %}
{% block content %}
<div class="route-page">
    <div class="route-layout">
        <div class="route-timer">
            <div class="stopwatch-container">
                <div id="stopwatch" class="stopwatch">{{ route.duration // 60 }}:{{ route.duration % 60 }}</div>
                <button id="stopwatch-toggle" class="stopwatch-button">START</button>
            </div>
        </div>
        {% include "utils/route_display.html" %}
    </div>
</div>

<div class="route-actions">
    <a href="{{ url_for('generate_route') }}" class="secondary-button">Generate New Route</a>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Stopwatch functionality
        const stopwatch = document.getElementById('stopwatch');
        const toggleButton = document.getElementById('stopwatch-toggle');
        const initialDuration = {{ route.duration }}; // Duration is already in seconds
        let timeLeft = initialDuration;
        let timer = null;
        let isRunning = false;

        function updateStopwatch() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            stopwatch.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            if (isRunning) return;
            
            isRunning = true;
            timer = setInterval(function() {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateStopwatch();
                } else {
                    stopTimer();
                    toggleButton.textContent = 'RESET';
                    stopwatch.style.color = 'var(--danger-color)';
                }
            }, 1000);
            toggleButton.textContent = 'STOP';
        }

        function stopTimer() {
            clearInterval(timer);
            timer = null;
            isRunning = false;
        }

        function resetTimer() {
            stopTimer();
            timeLeft = initialDuration;
            updateStopwatch();
            stopwatch.style.color = '';
            toggleButton.textContent = 'START';
        }

        toggleButton.addEventListener('click', function() {
            if (isRunning) {
                stopTimer();
                toggleButton.textContent = 'START';
            } else if (timeLeft <= 0) {
                resetTimer();
            } else {
                startTimer();
            }
        });

        updateStopwatch();

        // Draggable timer functionality
        const timerElement = document.querySelector('.route-timer');
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        timerElement.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;

            if (e.target === timerElement || e.target.closest('.stopwatch-container')) {
                isDragging = true;
            }
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                xOffset = currentX;
                yOffset = currentY;

                setTranslate(currentX, currentY, timerElement);
            }
        }

        function dragEnd() {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }

        function setTranslate(xPos, yPos, el) {
            el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
        }
    });
</script>
{% endblock %}