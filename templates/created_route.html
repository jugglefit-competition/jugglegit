{% extends "utils/base.html" %}
{% block title %}{% endblock %}
{% block content %}
<div class="route-page">
    <div class="route-layout">
        {% include "utils/route_display.html" %}
    </div>
</div>

<div class="route-actions">
    <div class="countdown-timer" id="timer-container">
        <div class="timer-header">
            <span>Timer</span>
            <button class="drag-handle">â‰¡</button>
        </div>
        <div id="countdown">Time remaining: <span id="timer"></span></div>
        <div class="timer-controls">
            <button id="startBtn" class="timer-btn">Start</button>
            <button id="stopBtn" class="timer-btn" disabled>Stop</button>
            <button id="resetBtn" class="timer-btn">Reset</button>
        </div>
    </div>
    <a href="{{ url_for('generate_route') }}" class="secondary-button">Generate New Route</a>
</div>

<script>
    // Initialize countdown timer
    let timeLeft = parseInt('{{ route.duration_seconds }}') || 600; // Default to 10 minutes if duration is invalid
    console.log('Initial timeLeft:', timeLeft); // Debug log
    let timerInterval = null;
    let isRunning = false;
    const originalTime = timeLeft;

    // Make timer draggable
    const timerContainer = document.getElementById('timer-container');
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset;
    let yOffset;

    timerContainer.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);

    function dragStart(e) {
        if (e.target.classList.contains('drag-handle') || e.target.closest('.timer-header')) {
            initialX = e.clientX;
            initialY = e.clientY;
            isDragging = true;
        }
    }

    function drag(e) {
        if (isDragging) {
            e.preventDefault();
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;
            
            xOffset = currentX;
            yOffset = currentY;
            
            setTranslate(currentX, currentY, timerContainer);
        }
    }

    function dragEnd(e) {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
    }

    function setTranslate(xPos, yPos, el) {
        el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
    }

    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('timer').textContent = 
            minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
        
        if (timeLeft > 0) {
            timeLeft--;
        } else {
            stopTimer();
            document.getElementById('countdown').textContent = "Time's up!";
        }
    }

    function startTimer() {
        if (!isRunning) {
            isRunning = true;
            timerInterval = setInterval(updateTimer, 1000);
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        }
    }

    function stopTimer() {
        if (isRunning) {
            isRunning = false;
            clearInterval(timerInterval);
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }
    }

    function resetTimer() {
        stopTimer();
        timeLeft = originalTime;
        document.getElementById('countdown').innerHTML = 'Time remaining: <span id="timer"></span>';
        updateTimer();
    }

    // Add event listeners for buttons
    document.getElementById('startBtn').addEventListener('click', startTimer);
    document.getElementById('stopBtn').addEventListener('click', stopTimer);
    document.getElementById('resetBtn').addEventListener('click', resetTimer);

    // Initialize timer display immediately
    updateTimer();
</script>
{% endblock %}